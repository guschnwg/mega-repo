version: '3'

services:
  webrtc_tunnel:
    container_name: webrtc_tunnel
    image: cloudflare/cloudflared:latest
    environment:
      - TUNNEL_TOKEN=$TUNNEL_TOKEN
    command: [
      "tunnel",
      "--no-autoupdate",
      "run",
      "--token",
      "$TUNNEL_TOKEN",
    ]
    networks:
      - shared
    restart: always

  webrtc:
    container_name: webrtc
    image: denoland/deno:1.43.6
    environment:
      - PWD=/code
    command: [
      "deno",
      "run",
      "--allow-net",
      "--allow-read",
      "/code/server.ts",
      "/code"
    ]
    volumes:
      - ./:/code:rw
    ports:
      - "5678:8080"
    networks:
      - shared
    restart: always

  client:
    container_name: client
    build:
      context: ./JSClient
      dockerfile: Dockerfile
    environment:
      - PASSWORD=$CLIENT_PASSWORD
      - WS_HOST=$WS_HOST
      - STREAM_URL=$STREAM_URL
    networks:
      - shared
    restart: always

  stream:
    image: aler9/rtsp-simple-server
    container_name: stream
    environment:
      - RTSP_PROTOCOLS=tcp
    networks:
      - shared
    ports:
      - "8554:8554"

  ffmpeg:
    image: jrottenberg/ffmpeg
    container_name: ffmpeg
    command: [
      "-stream_loop",
      "-1",
      "-i",
      "/video.mp4",
      "-rtsp_transport",
      "tcp",
      "-c:v",
      "libx264",
      "-preset",
      "ultrafast",
      "-tune",
      "zerolatency",
      "-b:v",
      "500k",
      "-c:a",
      "aac",
      "-strict",
      "experimental",
      "-f",
      "rtsp",
      "rtsp://stream:8554/live.stream"
    ]
    volumes:
      - ./video.mp4:/video.mp4:r
    networks:
      - shared
    restart: always

networks:
  shared: