<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body style="overflow: hidden;">
    <div>
        <canvas id="world" height="544" width="960"></canvas>
    </div>

    <div>
        <canvas id="camera" height="544" width="960"></canvas>
    </div>

    <div>
        <canvas id="fake-3d" height="544" width="960"></canvas>
    </div>

    <div>
        <canvas id="orthographic" height="544" width="960"></canvas>
    </div>

    <script>
        const tileSize = 32;
        const world = [
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
        ];

        const player = {
            x: 480 - 32,
            y: 320,
            angle: -55,
            distance: tileSize * 5,
            fov: 66,
            size: 10,
        };
    </script>

    <script>
        function toOriginScaled(x, origin = 0, scale = 1) {
            return x * scale - origin;
        }

        function drawWorld(ctx, originX = 0, originY = 0, scale = 1) {
            const size = tileSize * scale;
            for (let i = 0; i < world.length; i++) {
                for (let j = 0; j < world[i].length; j++) {
                    if (world[i][j] === 0) {
                        ctx.fillStyle = 'white';
                    } else if (world[i][j] == 1) {
                        ctx.fillStyle = 'black';
                    } else if (world[i][j] == 2) {
                        ctx.fillStyle = 'red';
                    } else if (world[i][j] == 3) {
                        ctx.fillStyle = 'purple';
                    }

                    const rectX = toOriginScaled(j, originX, size);
                    const rectY = toOriginScaled(i, originY, size);

                    ctx.fillRect(rectX, rectY, size, size);
                    ctx.strokeStyle = '#e6e6e6';
                    ctx.lineWidth = .2;
                    ctx.strokeRect(rectX, rectY, size, size);
                }
            }
        }

        function drawPlayer(ctx, originX = 0, originY = 0, scale = 1) {
            ctx.fillStyle = 'green';
            ctx.fillRect(
                toOriginScaled(player.x - player.size / 2, originX, scale),
                toOriginScaled(player.y - player.size / 2, originY, scale),
                player.size * scale,
                player.size * scale
            );

            ctx.beginPath();
            ctx.strokeStyle = 'limegreen';
            ctx.lineWidth = 3;
            ctx.moveTo(toOriginScaled(player.x, originX, scale), toOriginScaled(player.y, originY, scale));
            ctx.lineTo(
                toOriginScaled(player.x + Math.cos(player.angle * Math.PI / 180.0) * 15, originX, scale),
                toOriginScaled(player.y + Math.sin(player.angle * Math.PI / 180.0) * 15, originY, scale)
            );
            ctx.stroke();
        }

        function getNaiveRays(from) {
            const rays = [];
            for (let i = from.angle - from.fov / 2; i <= from.angle + from.fov / 2; i++) {
                const incrementX = Math.cos(i * Math.PI / 180.0);
                const incrementY = Math.sin(i * Math.PI / 180.0);
                const ray = { x: from.x + incrementX, y: from.y + incrementY, hit: false };
                for (let j = 0; j <= from.distance; j++) {
                    const xInWorld = Math.floor(ray.x / tileSize);
                    const yInWorld = Math.floor(ray.y / tileSize);

                    ray.x += incrementX;
                    ray.y += incrementY;

                    if (Boolean(world?.[yInWorld]?.[xInWorld])) {
                        ray.hit = true;
                        ray.distance = j;
                        break;
                    }
                }
                rays.push(ray);
            }
            return rays;
        }
        function getComplexRays(from) {
            const rays = [];

            // DDA?

            return rays;
        }
        let getRays = getNaiveRays;

        function drawRays(ctx, from, rays, originX = 0, originY = 0, scale = 1) {
            for (let ray of rays) {
                ctx.lineWidth = .2;
                if (ray.hit) {
                    ctx.strokeStyle = 'red';
                } else {
                    ctx.strokeStyle = 'blue';
                }
                ctx.beginPath();
                ctx.moveTo(toOriginScaled(from.x, originX, scale), toOriginScaled(from.y, originY, scale))
                ctx.lineTo(toOriginScaled(ray.x, originX, scale), toOriginScaled(ray.y, originY, scale));
                ctx.stroke();
            }
        }

        function drawDebug(ctx, originX = 0, originY = 0, scale = 1) {
            let worldX = Math.floor(player.x / tileSize) * tileSize;
            let worldY = Math.floor(player.y / tileSize) * tileSize;

            const cos = Math.cos(player.angle * Math.PI / 180.0);
            const sin = Math.sin(player.angle * Math.PI / 180.0);
        }

    </script>

    <script>
        function WorldGame() {
            const canvas = document.getElementById('world');
            const ctx = canvas.getContext('2d')

            function draw() {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

                drawWorld(ctx);
                drawPlayer(ctx);
                drawRays(ctx, player, getRays(player));
                drawDebug(ctx);
            }

            function update() {
                draw();
                requestAnimationFrame(update);
            }

            window.addEventListener('mousemove', e => {
                const rect = canvas.getBoundingClientRect();
                player.x = e.clientX - rect.left;
                player.y = e.clientY - rect.top;
            });

            window.addEventListener('keydown', e => {
                if (['ArrowLeft', 'a'].includes(e.key)) {
                    player.angle -= 1;
                } else if (['ArrowRight', 'd'].includes(e.key)) {
                    player.angle += 1;
                } else if (['ArrowUp', 'w'].includes(e.key)) {
                    player.distance += 10;
                } else if (['ArrowDown', 's'].includes(e.key)) {
                    player.distance -= 10;
                } else if (['+'].includes(e.key)) {
                    player.fov += 5;
                } else if (['-'].includes(e.key)) {
                    player.fov -= 5;
                } else if (['1'].includes(e.key)) {
                    getRays = getNaiveRays;
                } else if (['2'].includes(e.key)) {
                    getRays = getComplexRays;
                }
            });

            canvas.addEventListener('click', e => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const i = Math.floor(y / tileSize);
                const j = Math.floor(x / tileSize);
                console.log(i, j);
                world[i][j] = world[i][j] = (world[i][j] + 1) % 4;
            });

            update();
        }

        WorldGame();
    </script>

    <script>
        function CameraGame() {
            const canvas = document.getElementById('camera');
            const ctx = canvas.getContext('2d');

            function draw() {
                ctx.fillStyle = 'gray';
                ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);

                const scale = tileSize * 10 / player.distance;

                const originX = player.x * scale - ctx.canvas.width / 2;
                const originY = player.y * scale - ctx.canvas.height / 2;

                drawWorld(ctx, originX, originY, scale);
                drawPlayer(ctx, originX, originY, scale);
                drawRays(ctx, player, getRays(player), originX, originY, scale);

                drawDebug(ctx, originX, originY, scale);
            }

            function update() {
                draw();
                requestAnimationFrame(update);
            }

            update();
        }

        CameraGame();
    </script>

    <script>
        function Fake3DGame() {
            const canvas = document.getElementById('fake-3d');
            const ctx = canvas.getContext('2d');

            function draw() {
                ctx.fillStyle = 'gray';
                ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);

                const rays = getRays(player);

                drawDebug(ctx);
            }

            function update() {
                draw();
                requestAnimationFrame(update);
            }

            update();
        }

        Fake3DGame();
    </script>
</body>

</html>