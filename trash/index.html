<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <canvas height=250 width=250></canvas>

    <div id="destination"></div>
    <div id="mouse"></div>

    <script>
        const canvas = document.getElementsByTagName('canvas')[0];
        const ctx = canvas.getContext("2d");

        const destinationEl = document.getElementById('destination');
        const mouseEl = document.getElementById('mouse');

        const world = [
            [0, 1, 0, 0, 0],
            [0, 0, 1, 1, 0],
            [0, 0, 0, 1, 0],
            [0, 0, 0, 1, 0],
            [0, 0, 0, 1, 0],
        ];

        const player = {
            x: 1.2,
            y: 3.7,
        }

        const mouse = {
            x: 0,
            y: 0,
        }

        canvas.addEventListener('mousemove', e => {
            const rect = e.target.getBoundingClientRect();
            mouse.x = (e.clientX - rect.left) / 50; //x position within the element.
            mouse.y = (e.clientY - rect.top) / 50;  //y position within the element.
        })

        window.addEventListener('keydown', e => {
            if (e.key === 'w') {
                player.y -= 0.1;
            } else if (e.key === 's') {
                player.y += 0.1;
            } else if (e.key === 'a') {
                player.x -= 0.1;
            } else if (e.key === 'd') {
                player.x += 0.1;
            }
        })

        const destination = {
            x: 4,
            y: 1,
        }

        function draw() {
            // World
            world.forEach((row, rIndex) => {
                row.forEach((column, cIndex) => {
                    if (column == 0) {
                        ctx.fillStyle = 'black';
                    } else {
                        ctx.fillStyle = 'red';
                    }
                    ctx.fillRect(50 * cIndex, 50 * rIndex, 50, 50);
                    ctx.strokeStyle = 'lightgray';
                    ctx.strokeRect(50 * cIndex, 50 * rIndex, 50, 50);
                });
            });

            // Player
            ctx.beginPath()
            ctx.arc(player.x * 50, player.y * 50, 5, 0, 2 * Math.PI, false);
            ctx.fillStyle = 'blue';
            ctx.fill();

            // Line
            ctx.beginPath();
            ctx.strokeStyle = 'purple';
            ctx.moveTo(player.x * 50, player.y * 50);
            ctx.lineTo(mouse.x * 50, mouse.y * 50);
            ctx.stroke();

            // Destination
            ctx.beginPath();
            ctx.strokeStyle = 'yellow';
            ctx.moveTo(player.x * 50, player.y * 50);
            ctx.lineTo(destination.x * 50, destination.y * 50);
            ctx.stroke();

            info('Destination', destinationEl, player, destination);
            info('Mouse', mouseEl, player, mouse);

            setTimeout(draw, 1000 / 60);
        }

        function getAngle(first, second) {
            return Math.atan2(second.y - first.y, second.x - first.x);
        }

        function toDeg(inRad) {
            return inRad * (180 / Math.PI);
        }

        function info(title, el, from, to) {
            const distance = Math.sqrt(Math.pow(to.x - from.x, 2) + Math.pow(to.y - from.y, 2));
            const angleRad = getAngle(from, to)
            const angleDeg = toDeg(angleRad)
            const angleCos = Math.cos(angleRad)
            const angleSin = Math.sin(angleRad)
            const angleTan = Math.tan(angleRad)
            const oneUnitInX = 1 / angleCos;
            const oneUnitInY = 1 / angleSin;
            const xDirection = to.x - from.x > 0 ? 'right' : 'left';
            const yDirection = to.y - from.y > 0 ? 'down' : 'up';

            // const firstUnitInX = (1 - (from.x - Math.floor(from.x))) / angleCos;
            // const firstUnitInY = (1 - (from.y - Math.floor(from.y))) / angleSin;
            const firstUnitInX = oneUnitInX;
            const firstUnitInY = oneUnitInY;
            
            let remainerInX = Math.abs(firstUnitInX);
            let remainerInY = Math.abs(firstUnitInY);
            
            let currentX = from.x;
            let currentY = from.y;
            
            const increments = [];
            for (let i = 0 ; i < 2 ; i++) {
                // Debug add dot to where we are
                ctx.beginPath()
                ctx.arc(currentX * 50, currentY * 50, 4, 0, 2 * Math.PI, false);
                ctx.fillStyle = 'green';
                ctx.fill();
                // End debug

                if (remainerInX < remainerInY) {
                    increments.push(remainerInX);
                    remainerInY -= remainerInX;
                    
                    currentX += remainerInX * angleCos;
                    currentY += remainerInX * angleSin;

                    remainerInX = Math.abs(oneUnitInX);
                } else {
                    increments.push(remainerInY);
                    remainerInX -= remainerInY;
                    
                    currentY += remainerInY * angleSin;
                    currentX += remainerInY * angleCos;

                    remainerInY = Math.abs(oneUnitInY);
                }
            }

            el.innerHTML = `
                <h4>${title}: </h4>
                Distance: ${distance}
                <br />
                Angle: ${angleDeg}
                <br />
                One unit in X: ${oneUnitInX}
                <br />
                One unit in Y: ${oneUnitInY}
                <br />
                Direction in X: ${xDirection}
                <br />
                Direction in Y: ${yDirection}
                <br />
                Increments: ${increments.map(i => i.toFixed(2)).join(', ')}
                <br />
                Len: ${increments.reduce((acc, i) => acc + i, 0).toFixed(2)}
            `;
        }

        draw();

    </script>
</body>

</html>